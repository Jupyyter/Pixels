# --------------------------------------------------------------------------------
# --- 1. Settings & Variables ---
# --------------------------------------------------------------------------------
CXX = g++
EXECUTABLE = main
OBJ_DIR = obj

# --- NEW: Added IMGUI_DIR to the variables ---
SFML_DIR = ../SFML-3.0.0
GLM_DIR = ../glm/glm-master
BOX2D_DIR = ../2dbox
IMGUI_DIR = ../imgui-src
# ---------------------------------------------

# Folders to search for .cpp files and .hpp files
# --- NEW: Added IMGUI_DIR to SEARCH_DIRS ---
SEARCH_DIRS := src include $(IMGUI_DIR)

# --------------------------------------------------------------------------------
# --- 2. Magic Functions (Recursive Search) ---
# --------------------------------------------------------------------------------
rwildcard=$(foreach d,$(wildcard $(1)*),$(call rwildcard,$d/,$(2)) $(filter $(subst *,%,$(2)),$d))

# --------------------------------------------------------------------------------
# --- 3. Source Discovery ---
# --------------------------------------------------------------------------------
SOURCES := $(foreach dir,$(SEARCH_DIRS),$(call rwildcard,$(dir)/,*.cpp))
OBJECTS := $(SOURCES:%.cpp=$(OBJ_DIR)/%.o)
DEPENDENCIES := $(OBJECTS:.o=.d)

# --------------------------------------------------------------------------------
# --- 4. Library & Include Paths ---
# --------------------------------------------------------------------------------
BOX2D_LIB_DIR = $(BOX2D_DIR)/build/src
LOCAL_INCLUDE_DIR = include

# Compiler flags
CPP_STANDARD = -std=c++17
CXXFLAGS_COMMON = $(CPP_STANDARD) -DSFML_STATIC -MMD -MP

# Include directories:
# --- NEW: Added IMGUI_DIR to Include Paths ---
INCLUDE_DIRS = \
	-I$(SFML_DIR)/include \
	-I$(GLM_DIR) \
	-I$(LOCAL_INCLUDE_DIR) \
	-I$(BOX2D_DIR)/include \
	-I$(IMGUI_DIR) \
	-I. \
	$(addprefix -I,$(SEARCH_DIRS)) 

CXXFLAGS_RELEASE = $(CXXFLAGS_COMMON) $(INCLUDE_DIRS) -O2
CXXFLAGS_DEBUG = $(CXXFLAGS_COMMON) $(INCLUDE_DIRS) -g

# Linker flags
LDFLAGS = -L$(SFML_DIR)/lib -L$(BOX2D_LIB_DIR) -B"C:/mingwsfml/bin"

# Libraries
# Note: ImGui needs opengl32, which is already in your LIBS_COMMON
LIBS_COMMON = \
	-lopengl32 -lfreetype -lwinmm -lgdi32 -lpthread \
	-lbox2d

LIBS_RELEASE = -lsfml-graphics-s -lsfml-window-s -lsfml-system-s $(LIBS_COMMON)
LIBS_DEBUG   = -lsfml-graphics-s-d -lsfml-window-s-d -lsfml-system-s-d $(LIBS_COMMON)

# --------------------------------------------------------------------------------
# --- 5. Build Rules ---
# --------------------------------------------------------------------------------
all: run

run: release
	@echo "--- Running executable ---"
	./$(EXECUTABLE)

release: CXXFLAGS = $(CXXFLAGS_RELEASE)
release: LIBS = $(LIBS_RELEASE)
release: $(EXECUTABLE)

debug: CXXFLAGS = $(CXXFLAGS_DEBUG)
debug: LIBS = $(LIBS_DEBUG)
debug: $(EXECUTABLE)

# Linking the executable
$(EXECUTABLE): $(OBJECTS)
	@echo "--- Linking $@ ---"
	$(CXX) $(LDFLAGS) -o $@ $^ $(LIBS)

# Compiling Source Files
$(OBJ_DIR)/%.o: %.cpp
	@echo "Compiling $<..."
	@mkdir -p $(dir $@)
	$(CXX) $(CXXFLAGS) -c $< -o $@

# Include the dependency files generated by -MMD
-include $(DEPENDENCIES)

clean:
	@echo "--- Cleaning ---"
	rm -rf $(EXECUTABLE) $(OBJ_DIR)

.PHONY: all run release debug clean